// Generated by CoffeeScript 1.3.3
(function() {
  var Puzzle,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Puzzle = (function() {

    function Puzzle(canvas) {
      this.onPiecePressed = __bind(this.onPiecePressed, this);

      this.onStagePressed = __bind(this.onStagePressed, this);
      this.stage = new Stage(canvas);
      this.image = null;
      this.cutter = null;
      this.pieces = [];
    }

    Puzzle.prototype.initizlize = function(image, cutter) {
      var p, _i, _len, _ref, _results,
        _this = this;
      this.image = image;
      this.cutter = cutter;
      this.stage.enableMouseOver();
      this.stage.canvas.onmousewheel = function(e) {
        if (e.wheelDelta > 0) {
          return _this.zoom(e.x, e.y, 1.2);
        } else {
          return _this.zoom(e.x, e.y, 1 / 1.2);
        }
      };
      this.background = new Shape();
      this.background.onPress = this.onStagePressed;
      this.background.graphics.beginFill(Graphics.getRGB(0, 0, 0));
      this.background.graphics.rect(0, 0, screen.width, screen.height);
      this.stage.addChild(this.background);
      this.pieces = this.cutter.cut(this.image);
      _ref = this.pieces;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        this.stage.addChild(p);
        _results.push(p.onPress = this.onPiecePressed);
      }
      return _results;
    };

    Puzzle.prototype.update = function() {
      return this.stage.update();
    };

    Puzzle.prototype.updateBackground = function() {
      this.background.x = -this.stage.x / this.stage.scaleX;
      this.background.y = -this.stage.y / this.stage.scaleY;
      this.background.scaleX = 1 / this.stage.scaleX;
      return this.background.scaleY = 1 / this.stage.scaleY;
    };

    Puzzle.prototype.zoom = function(x, y, scale) {
      this.stage.scaleX = this.stage.scaleX * scale;
      this.stage.scaleY = this.stage.scaleX;
      this.stage.x = x - (x - this.stage.x) * scale;
      this.stage.y = y - (y - this.stage.y) * scale;
      this.updateBackground();
      return this.stage.update();
    };

    Puzzle.prototype.onStagePressed = function(e) {
      var last_point,
        _this = this;
      window.console.log('stage pressed: ' + e.stageX + ', ' + e.stageY);
      window.console.log(this);
      last_point = new Point(e.stageX, e.stageY);
      return e.onMouseMove = function(ev) {
        var pt;
        pt = new Point(ev.stageX, ev.stageY);
        window.console.log(pt.y - last_point.y);
        _this.stage.x += pt.x - last_point.x;
        _this.stage.y += pt.y - last_point.y;
        last_point = pt;
        _this.updateBackground();
        return _this.stage.update();
      };
    };

    Puzzle.prototype.onPiecePressed = function(e) {
      var last_point,
        _this = this;
      window.console.log('shape pressed: ' + e.stageX + ', ' + e.stageY);
      this.stage.addChild(e.target);
      this.stage.update();
      last_point = this.stage.globalToLocal(e.stageX, e.stageY);
      return e.onMouseMove = function(ev) {
        var pt;
        pt = _this.stage.globalToLocal(ev.stageX, ev.stageY);
        e.target.x += pt.x - last_point.x;
        e.target.y += pt.y - last_point.y;
        last_point = pt;
        return _this.stage.update();
      };
    };

    return Puzzle;

  })();

  this.Puzzle = Puzzle;

}).call(this);
